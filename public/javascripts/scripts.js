$(function(){function o(){$("form.login p.error, form.register p.error").remove(),$("form.login input, form.register input").removeClass("error")}var t=!0;$(".switch-button").on("click",function(e){e.preventDefault(),$("input").val(""),o(),t?(t=!1,$(".register").show("slow"),$(".login").hide()):(t=!0,$(".login").show("slow"),$(".register").hide())}),$("form.login input, form.register input").on("focus",function(){o()}),$(".register-button").on("click",function(t){t.preventDefault(),o();var e={login:$("#register-login").val(),password:$("#register-password").val(),passwordConfirm:$("#register-password-confirm").val()};$.ajax({type:"POST",data:JSON.stringify(e),contentType:"application/json",url:"/api/auth/register"}).done(function(o){o.ok?$(location).attr("href","/"):($(".register h2").after('<p class="error">'+o.error+"</p>"),o.fields&&o.fields.forEach(function(o){$("input[name="+o+"]").addClass("error")}))})}),$(".login-button").on("click",function(t){t.preventDefault(),o();var e={login:$("#login-login").val(),password:$("#login-password").val()};$.ajax({type:"POST",data:JSON.stringify(e),contentType:"application/json",url:"/api/auth/login"}).done(function(o){o.ok?$(location).attr("href","/"):($(".login h2").after('<p class="error">'+o.error+"</p>"),o.fields&&o.fields.forEach(function(o){$("input[name="+o+"]").addClass("error")}))})})}),$(function(){function o(){$("form.comment p.error").remove()}function t(o,t,e){if($(".reply").show(),$(".edit").show(),r&&r.remove(),n=null,r=$(".comment").clone(!0,!0),o)r.find(".cancel").hide(),r.appendTo(".comment-list");else{var i=$(t).parent().parent();n=i.attr("id"),$(t).parent().after(r)}e?(r.find(".send").hide(),r.find(".edit-send").show()):r.find(".edit-send").hide(),r.css({display:"flex"})}function e(o){var e='<ul><li style="background-color:#ffffe0;"><div class="head"><a href="/users/'+o.login+'">'+o.login+'</a><spam class="date">Только что</spam></div>'+o.body+"</li></ul>";$(r).after(e),t(!0)}var r,n,i=new WebSocket("ws://localhost:3001");$("form.comment textarea").on("focus",function(){o()}),$("#user-id").val()&&t(!0),$(".reply").on("click",function(){t(!1,this),$(this).hide()}),$(".edit").on("click",function(){t(!1,this,!0),$(this).hide()}),$("form.comment .cancel").on("click",function(o){o.preventDefault(),r.remove(),t(!0)}),$("form.comment .send").on("click",function(o){o.preventDefault();var t={post:$(".comments").attr("id"),body:r.find("textarea").val(),parent:n,userId:r.find("#user-id").val()};console.log(t),i.send(JSON.stringify(t))}),$(".delete").on("click",function(o){o.preventDefault();var t={commentId:$(this).parent().parent().attr("id")};console.log(t),$.ajax({type:"DELETE",data:JSON.stringify(t),contentType:"application/json",url:"/comment"}).done(function(o){console.log(o),o.ok?location.reload():(o.error||(o.error="Неизвестная ошибка!"),$(r).prepend('<p class="error">'+o.error+"</p>"))})}),$(".edit-send").on("click",function(o){o.preventDefault();var t={commentId:$(this).parent().parent().parent().attr("id"),body:r.find("textarea").val()};console.log(t),$.ajax({type:"PUT",data:JSON.stringify(t),contentType:"application/json",url:"/comment"}).done(function(o){console.log(o),o.ok?location.reload():(o.error||(o.error="Неизвестная ошибка!"),$(r).prepend('<p class="error">'+o.error+"</p>"))})}),i.onmessage=function(o){var t=o.data;t=JSON.parse(t),console.log(t),t.ok?e(t):$(r).prepend('<p class="error">'+t.error+"</p>")}}),$(function(){function o(){$(".post-form p.error").remove(),$(".post-form input, #post-body").removeClass("error")}$(".post-form input, #post-body").on("focus",function(){o()}),$(".publish-button, .save-button").on("click",function(t){t.preventDefault(),o();var e="save-button"===$(this).attr("class").split(" ")[0],r={title:$("#post-title").val(),body:$("#post-body").val(),isDraft:e,postId:$("#post-id").val()};$.ajax({type:"POST",data:JSON.stringify(r),contentType:"application/json",url:"/post/add"}).done(function(o){console.log(o),o.ok?e?$(location).attr("href","/post/edit/"+o.post.id):$(location).attr("href","/posts/"+o.post.url):($(".post-form h2").after('<p class="error">'+o.error+"</p>"),o.fields&&o.fields.forEach(function(o){$("#post-"+o).addClass("error")}))})}),$(".img-container").on("click",function(){console.log("click img");var o=$(this).attr("id"),t=$("#post-body"),e=t[0].selectionStart,r=t.val(),n="![alt text](image"+o+")";t.val(r.substring(0,e)+n+r.substring(e))}),$(".remove-button").on("click",function(o){o.preventDefault();var t={postId:$("#post-id").val()};$.ajax({type:"DELETE",data:JSON.stringify(t),contentType:"application/json",url:"/post/remove"}).done(function(o){console.log(o),o.ok?$(location).attr("href","/"):($(".post-form h2").after('<p class="error">'+o.error+"</p>"),o.fields&&o.fields.forEach(function(o){$("#post-"+o).addClass("error")}))})})}),$("#file").on("change",function(){var o=new FormData;o.append("postId",$("#post-id").val()),o.append("file",$("#file")[0].files[0]),$.ajax({type:"POST",url:"/upload/image",data:o,processData:!1,contentType:!1,success:function(o){console.log(o),o.ok?$("#fileInfo").prepend('<div class="img-container" id="'+o.uploadDB.id+'"><img src="/uploads'+o.uploadDB.path+'" alt=""></div>').on("click",function(){console.log("click img");var o=$(this).children().attr("id"),t=$("#post-body"),e=t[0].selectionStart,r=t.val(),n="![alt text](image"+o+")";t.val(r.substring(0,e)+n+r.substring(e))}):$(".post-form h2").after('<p class="error">'+o.error+"</p>")},error:function(o){console.log(o)}})});